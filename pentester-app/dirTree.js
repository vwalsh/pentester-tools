/* eslint-env node */

import dirTree from 'directory-tree'
import { flatten } from 'flat'
import fs from 'fs'

const toolsPath = process.argv?.[2]

if (toolsPath !== undefined) {
  const tree = dirTree(toolsPath)

  const filelist = flatten(tree)
  let content = {
    ver: '0.1',
    path: toolsPath,
    tree: [],
  }

  // console.log({filelist})

  for (const [key, value] of Object.entries(filelist)) {
    if (
      key.indexOf('.path') === key.length - 5 &&
      value.toLowerCase().indexOf('node_modules') < 0 &&
      value.toLowerCase().indexOf('.git') < 0 &&
      value.indexOf(toolsPath) === 0
    ) {
      // console.log({value})

      try {
        if (!fs.lstatSync(value).isDirectory()) {
          content.tree.push(value.replace(toolsPath, ''))
        }
      } catch (e) {
        console.log('ERROR: unable to lstatSync', value, e)
      }
    }
  }

  fs.writeFile('./src/assets/dirtree.json', JSON.stringify(content), (err) => {
    if (err) {
      console.error(err)
    }
    console.log('successfully saved to ./src/assets/dirtree.json')
  })
}
