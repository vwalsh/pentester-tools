import {
  IconButton,
  InputAdornment,
  TextField,
  TextFieldProps,
} from '@mui/material'
import React, { useEffect, useRef } from 'react'
import { useComputed, useSignal } from '@preact/signals-react'
import CloseIcon from '@mui/icons-material/Close'
import { disablePageScrolling, enablePageScrolling } from '../../utils'

interface Props {
  props: TextFieldProps
  numberChangeEvent: (n: number) => void
  defaultValue: number
  disabled?: boolean
}

const NumberInput = React.memo(
  ({ props, numberChangeEvent, defaultValue, disabled }: Props) => {
    const inputRef = useRef<HTMLElement | null>(null)
    const tmpVal = useSignal<number>(defaultValue)
    const error = useSignal<boolean>(false)

    const customProps = useComputed(() => {
      const tmp = props
      tmp.InputProps = {
        ...props.InputProps,
        endAdornment: (
          <InputAdornment position="end">
            <IconButton
              tabIndex={-1}
              title={`reset to default: ${defaultValue}`}
              disabled={disabled}
              onClick={() => {
                tmpVal.value = defaultValue
                numberChangeEvent(defaultValue)
              }}
            >
              <CloseIcon color="error" />
            </IconButton>
          </InputAdornment>
        ),
      }

      return tmp
    })

    useEffect(() => {
      if (typeof props.value === 'number') {
        tmpVal.value = props.value
      }
    }, [props.value, tmpVal])

    return (
      <TextField
        type="number"
        error={error.value}
        color={
          disabled === false && disabled !== undefined ? 'success' : 'primary'
        }
        disabled={disabled}
        focused={
          disabled === false && disabled !== undefined ? true : undefined
        }
        helperText={error.value === true ? 'Only numbers are allowed' : ''}
        onChange={(event: React.ChangeEvent<HTMLInputElement>) => {
          const tmp = parseInt(event.target.value)

          if (isNaN(tmp)) {
            // this stops the user from shooting themselves in the foot.
            error.value = true
            return
          }

          error.value = false
          numberChangeEvent(tmp)
          tmpVal.value = tmp
        }}
        // all of the following events for element focusing are to ensure that the
        //  entire web page gets re-enabled to scroll
        onFocus={(event) => {
          if (event.currentTarget.nodeName.toLowerCase() === 'input') {
            inputRef.current = event.currentTarget
          } else if (event.currentTarget.querySelector('input') !== null) {
            inputRef.current = event.currentTarget.querySelector('input')
          }

          event.target.select()

          disablePageScrolling()
        }}
        onKeyDown={(event) => {
          if (inputRef.current === undefined || inputRef.current === null) {
            inputRef.current = event.currentTarget.querySelector('input')
          }

          if (
            event.code.toLowerCase() === 'tab' ||
            event.code.toLowerCase() === 'escape'
          ) {
            enablePageScrolling(inputRef.current)
          }
        }}
        onBlur={() => {
          enablePageScrolling(inputRef.current)
        }}
        onMouseLeave={() => {
          enablePageScrolling(inputRef.current)
        }}
        // the custom props applied
        {...customProps.value}
        value={tmpVal.value}
      />
    )
  }
)

export default NumberInput
