import React, { useContext } from 'react'
import { AppState } from '../../../Home'
import { useComputed, useSignalEffect } from '@preact/signals-react'
import { Box } from '@mui/material'
import AlertDialog from '../../../../../components/AlertDialog'
import ConfigInput from '../../ConfigInput'
import RenderMarkdown from '../../../../../components/RenderMarkdown'

export interface ConfigCompsProps {
  windowNum: number
}
const CommandTools = React.memo(({ windowNum }: ConfigCompsProps) => {
  const { command_windows, replacements, setReplacements, replacedValues } =
    useContext(AppState)

  const cwin = useComputed(() => {
    return command_windows.value[windowNum]
  })

  useSignalEffect(() => {
    if (cwin.value?.config === undefined) {
      return
    }
    // sets the default replacements values if they aren't defined already
    cwin.value.config.map((cfg) => {
      if (replacements.value[cfg.replace] === undefined) {
        let replVal = ''

        if (cfg.props.type === 'checkbox') {
          replVal = !!cfg.defaultValue === false ? '' : cfg.props.replaceValue
        } else {
          replVal = cfg.defaultValue.toString()
        }

        setReplacements({
          name: cfg.replace,
          value: replVal,
        })
      }
    })
  })

  const Tools = React.memo(() => {
    const computedMap = useComputed(() => {
      if (cwin.value?.config === undefined) {
        return []
      }
      return cwin.value.config.map((cfg) => {
        const highlightFound = replacedValues.value.indexOf(
          `id-${cwin.value.id}-win-${cwin.value.win}-${cfg.replace}`
        )

        return {
          key: btoa(JSON.stringify(cfg)),
          cfg: cfg,
          title: cfg.props.label,
          help: cfg.help,
          defaultValue: cfg.defaultValue,
          highlightComponent: highlightFound > -1,
        }
      })
    })

    if (
      cwin.value?.config === undefined ||
      cwin.value?.config?.length === undefined ||
      cwin.value.config.length < 1
    ) {
      return (
        <React.Fragment
          key={`command_windows_${windowNum}-${cwin.value?.win}`}
        ></React.Fragment>
      )
    }

    return computedMap.value.map((comp) => {
      return (
        <Box sx={{ display: 'block', breakInside: 'avoid' }} key={comp.key}>
          <Box sx={{ display: 'flex', minHeight: '75px', padding: '5px' }}>
            <AlertDialog title={comp.title}>
              <RenderMarkdown mdText={comp.help} />
            </AlertDialog>

            <ConfigInput
              highlightComponent={comp.highlightComponent}
              replacements={replacements}
              cfg={comp.cfg}
              defaultValue={comp.defaultValue}
            />
          </Box>
        </Box>
      )
    })
  })

  if (
    command_windows.value === undefined ||
    command_windows.value.length < 1 ||
    command_windows.value.length < windowNum
  ) {
    return <React.Fragment key={`command_windows_undefined`}></React.Fragment>
  }

  return (
    <Box
      sx={{
        width: 'calc( 100% - 20px )',
        padding: '10px',
        columns: '2',
        breakInside: 'avoid',
      }}
      key={`command_windows_defined`}
    >
      <Tools />
    </Box>
  )
})

export default CommandTools
