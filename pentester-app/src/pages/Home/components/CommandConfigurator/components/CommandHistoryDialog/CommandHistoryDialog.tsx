import React, { useContext } from 'react'
import WorkHistoryIcon from '@mui/icons-material/WorkHistory'

import AlertDialog from '../../../../../../components/AlertDialog'
import { AppState } from '../../../../Home'
import {
  List,
  TextField,
  InputAdornment,
  IconButton,
  Box,
  ListItem,
  Typography,
} from '@mui/material'
import { useComputed, useSignal } from '@preact/signals-react'
import CloseIcon from '@mui/icons-material/Close'

import CodeTypography from '../../../../../../components/CodeTypography'
import CopyItem from '../../../../../../components/CopyItem'

const CommandHistoryDialog = React.memo(() => {
  const search = useSignal<string>('')

  const { commandHistory } = useContext(AppState)

  const HistoryFound = useComputed(() => {
    if (search.value === '') {
      return <></>
    }

    let tmp = []
    if (search.value === '*') {
      // return all
      tmp = commandHistory.value
    } else {
      // return only found search entries
      tmp = commandHistory.value.filter((cmd) => {
        return cmd.toLowerCase().indexOf(search.value.toLowerCase()) > -1
      })
    }

    return tmp.map((cmd, index) => {
      return (
        <ListItem
          key={`found-loot-${cmd}-${index}-${search.value}`}
          sx={{ borderBottom: '1px solid #cecece' }}
        >
          <Box
            sx={{
              width: '100%',
              display: 'flex',
              alignContent: 'center',
              alignItems: 'center',
            }}
          >
            <Typography variant="h5">{index}.</Typography>
            <CopyItem val={cmd}>
              <CodeTypography>{cmd}</CodeTypography>
            </CopyItem>
          </Box>
        </ListItem>
      )
    })
  })

  return (
    <AlertDialog title="Command History" CustomIcon={<WorkHistoryIcon />}>
      <>
        <Typography>
          Command History is created each time a command is copied. Use the
          search box to find commands that contain the search term. The commands
          are displayed from oldest (at the top) to newest (at the bottom).
        </Typography>
        <Box
          sx={{ display: 'flex', alignContent: 'center', alignItems: 'center' }}
        >
          <Typography
            sx={{ textAlign: 'right', padding: '5px', marginTop: '10px' }}
          >
            {HistoryFound.value?.length === undefined
              ? 0
              : HistoryFound.value.length}{' '}
            of {commandHistory.value.length} shown
          </Typography>
          <TextField
            label="Search Command History"
            placeholder="* (asterisk) for all history"
            sx={{ marginTop: '15px' }}
            fullWidth
            value={search.value}
            onChange={(event: React.ChangeEvent<HTMLInputElement>) => {
              search.value = event.target.value
            }}
            InputProps={{
              endAdornment: (
                <InputAdornment position="end">
                  <IconButton
                    onClick={() => {
                      search.value = ''
                    }}
                  >
                    <CloseIcon />
                  </IconButton>
                </InputAdornment>
              ),
            }}
          />
        </Box>
        <List
          sx={{
            width: '100%',
            maxWidth: '100%',
            // bgcolor: 'background.paper',
            position: 'relative',
            overflowX: 'hidden',
            overflowY: 'auto',
            maxHeight: '70vh',
          }}
        >
          {HistoryFound.value}
        </List>
      </>
    </AlertDialog>
  )
})

export default CommandHistoryDialog
