import { ListItem, IconButton } from '@mui/material'
import React, { useCallback, useContext } from 'react'
import CopyItem from '../../../../../components/CopyItem'
import { ConfigCompsProps } from './CommandTools'
import { useComputed } from '@preact/signals-react'
import { AppState } from '../../../Home'
import CloudDownloadIcon from '@mui/icons-material/CloudDownload'

const DownloadFiles = React.memo(({ windowNum }: ConfigCompsProps) => {
  const { command_windows } = useContext(AppState)

  const cwin = useComputed(() => {
    return command_windows.value[windowNum]
  })

  const download_file = useCallback((filename: string, b64data: string) => {
    const data = new Blob([atob(b64data)], { type: 'text' })
    const csvURL = window.URL.createObjectURL(data)
    const tempLink = document.createElement('a')
    tempLink.href = csvURL
    tempLink.setAttribute('download', filename)
    tempLink.click()
  }, [])

  if (cwin.value?.code?.length === undefined || cwin.value.code.length < 1) {
    return <></>
  }

  return cwin.value.code.map((code) => {
    return (
      <ListItem key={code.filename}>
        <CopyItem val={atob(code.data)}>
          <IconButton
            onClick={() => {
              download_file(code.filename, code.data)
            }}
          >
            {code.filename}&nbsp;
            <CloudDownloadIcon />
          </IconButton>
        </CopyItem>
      </ListItem>
    )
  })
})

export default DownloadFiles
