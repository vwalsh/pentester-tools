import {
  Autocomplete,
  Box,
  ButtonGroup,
  Grid,
  TextField,
  Typography,
} from '@mui/material'
import IPv4Input from '../../components/IPv4Input'
import OmniSearch from './components/OmniSearch'
import CommandConfigurator from './components/CommandConfigurator'

import HTTPToolsFiles from '../../assets/dirtree.json'
import { useSignalEffect } from '@preact/signals-react'
import { createContext, useContext } from 'react'
import createCommandConfiguratorState from '../../signals/signals'
import GlobalReplacementsDialog from '../../components/GlobalReplacementsDialog'
import LootDialog from './components/CommandConfigurator/components/LootDialog'
import AlertDialog from '../../components/AlertDialog'
import CommandHistoryDialog from './components/CommandConfigurator/components/CommandHistoryDialog'
import React from 'react'

const signalState = createCommandConfiguratorState()
export const AppState = createContext(signalState)

const Home = React.memo(() => {
  return (
    <AppState.Provider value={signalState}>
      <HomeUi />
    </AppState.Provider>
  )
})

const HomeUi = React.memo(() => {
  const { httpFile, ahost, aport, vhost, vport, fileSearchEnabled } =
    useContext(AppState)

  useSignalEffect(() => {
    httpFile.value =
      httpFile.value === undefined || httpFile.value === ''
        ? HTTPToolsFiles.tree[0]
        : httpFile.value
  })

  return (
    <>
      <Box sx={{ display: 'flex', margin: '10px' }}>
        <AlertDialog title="Help: What is this tool?">
          <Typography>
            The components on this page help to create a command-to-run for your
            pentest. Start by searching for a type of task to accomplish.
            <br />
            <br />
            On the left the search results will populate buttons, these are the
            Commands that can be built to run. Click a Command on the left to
            populate a window on the right. If the search results have Commands
            with more than Window 0 options, then typically there are multiple
            commands to run or setup to accomplish this task.
            <br />
            <br />
            With some Windows populated on the right, start selecting the values
            for the given flags/options to configure the command-to-run.
            <br />
            <br />
            When finished configuring the command, review it for errors and then
            click the Copy button on the left of the command text. Now you're
            ready to paste this command where you need to run it.
            <br />
            <br />
            See each info icon for specific help.
          </Typography>
        </AlertDialog>
        <Typography variant="h4">Pentester Command Configurator</Typography>
      </Box>
      <Grid container spacing={2}>
        <Grid item xs={6}>
          <IPv4Input
            hostSignal={ahost}
            portSignal={aport}
            defaultOctets={[192, 168, 90, 100]}
            role="attacker"
            akaName="kali"
          />
        </Grid>
        <Grid item xs={6}>
          <IPv4Input
            hostSignal={vhost}
            portSignal={vport}
            defaultOctets={[192, 168, 10, 200]}
            role="victim"
            akaName="target"
          />
        </Grid>

        <Grid item xs={3}>
          <OmniSearch />
        </Grid>

        <Grid item xs={2}>
          <ButtonGroup
            variant="outlined"
            size="large"
            aria-label="Global Tools Group"
          >
            <GlobalReplacementsDialog />
            <LootDialog />
            <CommandHistoryDialog />
          </ButtonGroup>
        </Grid>
        <Grid item xs={4}>
          {fileSearchEnabled.value === true && (
            <>
              <Autocomplete
                disablePortal
                id="omni-filesearch-box"
                options={HTTPToolsFiles.tree as Array<string>}
                sx={{ width: 300 }}
                value={httpFile.value}
                renderInput={(params) => (
                  <TextField {...params} label="Tools File Search..." />
                )}
                onChange={(
                  _event: React.SyntheticEvent,
                  newValue: string | null
                ) => {
                  httpFile.value = newValue === null ? '' : newValue
                }}
              />
            </>
          )}
        </Grid>
        <Grid item xs={3}></Grid>
      </Grid>

      <hr />

      <Box sx={{ minHeight: 'calc( 100vh - 600px )' }}>
        <CommandConfigurator />
      </Box>
    </>
  )
})

export default Home
